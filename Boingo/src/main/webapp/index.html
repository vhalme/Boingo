<!doctype html> 

<!-- paulirish.com/2008/conditional-stylesheets-vs-css-hacks-answer-neither/ -->
<!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if IE 7]>    <html class="no-js lt-ie9 lt-ie8" lang="en"> <![endif]-->
<!--[if IE 8]>    <html class="no-js lt-ie9" lang="en"> <![endif]-->
<!-- Consider adding a manifest.appcache: h5bp.com/d/Offline -->

<!--[if gt IE 8]><!-->
<html class="no-js" lang="en">
<!--<![endif]-->
	
	<head>

		<meta charset="utf-8">

		<!-- Use the .htaccess and remove these lines to avoid edge case issues.
		More info: h5bp.com/i/378 -->
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

		<title></title>
		<meta name="description" content="">

		<!-- Mobile viewport optimized: h5bp.com/viewport -->
		<meta name="viewport" content="width=device-width">

		<!-- Place favicon.ico and apple-touch-icon.png in the root directory: mathiasbynens.be/notes/touch-icons -->
		
		<!-- Template style sheet -->
		<link rel="stylesheet" href="css/html5boilerplate.css">
		
		<!-- App styles -->
		<link rel="stylesheet" href="css/style.css">

		<!-- All JavaScript at the bottom, except this Modernizr build.
		Modernizr enables HTML5 elements & feature detects for optimal performance.
		Create your own custom Modernizr build: www.modernizr.com/download/ -->
		<script src="js/libs/modernizr-2.5.3.min.js"></script>
		
	</head>
	<body>
		
		<!-- Prompt IE 6 users to install Chrome Frame. Remove this if you support IE 6.
		chromium.org/developers/how-tos/chrome-frame-getting-started -->
		<!--[if lt IE 7]><p class=chromeframe>Your browser is <em>ancient!</em> <a href="http://browsehappy.com/">Upgrade to a different browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">install Google Chrome Frame</a> to experience this site.</p><![endif]-->
		
		Boingo!
		
		<script src="js/libs/three.min.js"></script>

		<script src="js/libs/stats.min.js"></script>

		<script>

			var container, stats;

			var camera, scene, renderer;
			var camZDelta = 0;
			var camXDelta = 0;
			var vehDir = 0, trackDir = 0;
			var vehAngle = Math.PI / 2, trackAngle = 0;

			var vehicle, plane, floor, mark;

			var targetRotation = 0;
			var targetRotationOnMouseDown = 0;

			var mouseX = 0;
			var mouseXOnMouseDown = 0;

			var windowHalfX = window.innerWidth / 2;
			var windowHalfY = window.innerHeight / 2;
			
			var info;

			var fwd = 0;
			
			init();
			animate();

			function init() {

				container = document.createElement( 'div' );
				document.body.appendChild( container );

				info = document.createElement( 'div' );
				info.style.position = 'absolute';
				info.style.top = '10px';
				info.style.width = '100%';
				info.style.textAlign = 'center';
				
				container.appendChild( info );

				camera = new THREE.PerspectiveCamera( 25, window.innerWidth / window.innerHeight, 1, 10000 );
				camera.target = new THREE.Vector3( 0, 0, 0 );
				camera.position.set( 0, 1000, 0 );

				scene = new THREE.Scene();
				
				// Floor
				
				//var planeSimple = new THREE.PlaneGeometry( 200, 300 );
				//var planeTesselated = new THREE.PlaneGeometry( 100, 300, 25, 40 );
				var planeTesselated = new THREE.PlaneGeometry( 1200, 360, 12, 3 );
				var matWire = new THREE.MeshBasicMaterial( { color :0x110000, wireframe: true, wireframeLinewidth: 0.1 } );

				floor = new THREE.Mesh( planeTesselated, matWire );
				floor.rotation.x = - Math.PI / 2;
				floor.position.set( 0, 0, 0 );
				scene.add( floor );

				// Vehicle

				var geometry = new THREE.CubeGeometry( 20, 10, 30 );
				
				geometry.faces[0].color.setHex( 0x888888 );
				geometry.faces[1].color.setHex( 0xacacac );
				geometry.faces[2].color.setHex( 0xe0e0e0 );
				geometry.faces[3].color.setHex( 0xd3d3d3 );
				geometry.faces[4].color.setHex( 0x777777 );
				geometry.faces[5].color.setHex( 0xa0a0a0 );
				
				var material = new THREE.MeshBasicMaterial( { vertexColors: THREE.FaceColors } );

				vehicle = new THREE.Mesh( geometry, material );
				vehicle.position.set( 0, 30, 0 );
				scene.add( vehicle );
				
				var geometry = new THREE.CubeGeometry( 5, 5, 5 );
				
				geometry.faces[0].color.setHex( 0xff0000 );
				geometry.faces[1].color.setHex( 0xff0000 );
				geometry.faces[2].color.setHex( 0xff0000 );
				geometry.faces[3].color.setHex( 0xff0000 );
				geometry.faces[4].color.setHex( 0xff0000 );
				geometry.faces[5].color.setHex( 0xff0000 );
				
				var markMaterial = new THREE.MeshBasicMaterial( { vertexColors: THREE.FaceColors } );

				mark = new THREE.Mesh( geometry, markMaterial );
				mark.position.set( 0, 30, 200 );
				scene.add( mark );
				
				var geometry = new THREE.CubeGeometry( 5, 5, 5 );
				
				geometry.faces[0].color.setHex( 0x0000ff );
				geometry.faces[1].color.setHex( 0x0000ff );
				geometry.faces[2].color.setHex( 0x0000ff );
				geometry.faces[3].color.setHex( 0x0000ff );
				geometry.faces[4].color.setHex( 0x0000ff );
				geometry.faces[5].color.setHex( 0x0000ff );
				
				var mark2Material = new THREE.MeshBasicMaterial( { vertexColors: THREE.FaceColors } );

				mark2 = new THREE.Mesh( geometry, mark2Material );
				mark2.position.set( 0, 30, 200 );
				scene.add( mark2 );

				// Shadow
				
				/*
				var geometry = new THREE.PlaneGeometry( 200, 200 );
				geometry.applyMatrix( new THREE.Matrix4().makeRotationX( - Math.PI / 2 ) );

				var material = new THREE.MeshBasicMaterial( { color: 0xe0e0e0 } );

				plane = new THREE.Mesh( geometry, material );
				scene.add( plane );
				*/

				renderer = new THREE.WebGLRenderer();
				renderer.setSize( window.innerWidth, window.innerHeight );

				container.appendChild( renderer.domElement );

				stats = new Stats();
				stats.domElement.style.position = 'absolute';
				stats.domElement.style.top = '0px';
				container.appendChild( stats.domElement );

				document.addEventListener( 'mousedown', onDocumentMouseDown, false );
				document.addEventListener( 'touchstart', onDocumentTouchStart, false );
				document.addEventListener( 'touchmove', onDocumentTouchMove, false );
				
				document.addEventListener( 'keyup', onKeyUp, false );
				document.addEventListener( 'keydown', onKeyDown, false );

				//

				window.addEventListener( 'resize', onWindowResize, false );
				

			}

			function onWindowResize() {

				windowHalfX = window.innerWidth / 2;
				windowHalfY = window.innerHeight / 2;

				camera.aspect = window.innerWidth / window.innerHeight;
				camera.updateProjectionMatrix();

				renderer.setSize( window.innerWidth, window.innerHeight );

			}

			function onKeyUp(event) {
				
				event.preventDefault();
				
				if(event.keyCode == 38) {
					
					fwd = 0;
				
				} else if(event.keyCode == 37) {
					
					vehDir = 0;
					
					
				} else if(event.keyCode == 39) {
					
					vehDir = 0;
					
					
				} else if(event.keyCode == 65) {
					
					trackDir = 0;
					
					
				} else if(event.keyCode == 68) {
					
					trackDir = 0;
					
					
				}
			
			}
			
			
			function onKeyDown(event) {
				
				event.preventDefault();
			
				if(event.keyCode == 38) {
					
					fwd = 6;
				
				} else if(event.keyCode == 37) {
					
					vehDir = 0.02;
						
				} else if(event.keyCode == 39) {
					
					vehDir = -0.02;
				
				} else if(event.keyCode == 65) {
					
					trackDir = 0.02;
					
					
				} else if(event.keyCode == 68) {
					
					trackDir = -0.02;
					
					
				}
				
			}
			
			
			function onDocumentMouseDown( event ) {

				event.preventDefault();

				document.addEventListener( 'mousemove', onDocumentMouseMove, false );
				document.addEventListener( 'mouseup', onDocumentMouseUp, false );
				document.addEventListener( 'mouseout', onDocumentMouseOut, false );

				mouseXOnMouseDown = event.clientX - windowHalfX;
				targetRotationOnMouseDown = targetRotation;

			}

			function onDocumentMouseMove( event ) {

				mouseX = event.clientX - windowHalfX;

				targetRotation = targetRotationOnMouseDown + ( mouseX - mouseXOnMouseDown ) * 0.02;

			}

			function onDocumentMouseUp( event ) {

				document.removeEventListener( 'mousemove', onDocumentMouseMove, false );
				document.removeEventListener( 'mouseup', onDocumentMouseUp, false );
				document.removeEventListener( 'mouseout', onDocumentMouseOut, false );

			}

			function onDocumentMouseOut( event ) {

				document.removeEventListener( 'mousemove', onDocumentMouseMove, false );
				document.removeEventListener( 'mouseup', onDocumentMouseUp, false );
				document.removeEventListener( 'mouseout', onDocumentMouseOut, false );

			}

			function onDocumentTouchStart( event ) {

				if ( event.touches.length === 1 ) {

					event.preventDefault();

					mouseXOnMouseDown = event.touches[ 0 ].pageX - windowHalfX;
					targetRotationOnMouseDown = targetRotation;

				}

			}

			function onDocumentTouchMove( event ) {

				if ( event.touches.length === 1 ) {

					event.preventDefault();

					mouseX = event.touches[ 0 ].pageX - windowHalfX;
					targetRotation = targetRotationOnMouseDown + ( mouseX - mouseXOnMouseDown ) * 0.05;

				}

			}


			function animate() {

				requestAnimationFrame( animate );

				render();
				stats.update();

			}

			function render() {
				
				vehAngle += vehDir;
				trackAngle += trackDir;
				
				var dz = -Math.cos(vehAngle);
				var dx = -Math.sin(vehAngle);
				
				vehicle.rotation.y = vehAngle;
				floor.rotation.z = trackAngle;
				
				var vPosX = vehicle.position.x + dx*fwd;
				var vPosZ = vehicle.position.z + dz*fwd;
				
				var vdx1 = vPosX - floor.position.x;
				var vdz1 = vPosZ - floor.position.z;
				var vd1 = (Math.sqrt(vdx1*vdx1 + vdz1*vdz1));
				
				var vdx2 = vPosX - floor.position.x;
				var vdz2 = vPosZ - floor.position.z;
				var vd2 = (Math.sqrt(vdx2*vdx2 + vdz2*vdz2));
				
				var mTopX = Math.sin(trackAngle-Math.PI*(1/2))*600;
				var mTopZ = Math.cos(trackAngle-Math.PI*(1/2))*600;
				
				var mBottomX = Math.sin(trackAngle-Math.PI*(3/2))*600;
				var mBottomZ = Math.cos(trackAngle-Math.PI*(3/2))*600;
				
				mark.position.x = mTopX;
				mark.position.z = mTopZ;
				
				mark2.position.x = Math.sin(trackAngle)*180;
				mark2.position.z = Math.cos(trackAngle)*180;
				
				var vehicleAxisAngle = Math.atan(vdx1 / vdz1);
				var trackAxisAngle = Math.atan(mark.position.x / mark.position.z);
				
				var dAngle = vehicleAxisAngle - trackAxisAngle;
				var shortAxis = Math.cos(dAngle)*vd1;
				
				var axisRem = 600 - Math.abs(shortAxis);
				
				var vehicleAxisAngle2 = Math.atan(vdx2 / vdz2);
				var trackAxisAngle2 = Math.atan(mark2.position.x / mark2.position.z);
				
				var dAngle2 = vehicleAxisAngle2 - trackAxisAngle2;
				var shortAxis2 = Math.cos(dAngle2)*vd2;
				
				var axisRem2 = 180 - Math.abs(shortAxis2);
				
				info.innerHTML = 
					'('+Math.round(vehicle.position.z)+','+Math.round(vehicle.position.x)+'); '+
					'('+Math.round(camera.position.z)+','+Math.round(camera.position.x)+'); '+
					'('+Math.round(floor.position.z)+','+Math.round(floor.position.x)+'); '+
					'('+Math.round(trackAngle, 2)+','+Math.round(floor.position.x)+'); ';
				
				
				
				if(axisRem < 300) {
					
					floor.position.x = vehicle.position.x;
					//floor.position.z = vehicle.position.z;
						
				}
				
				if(axisRem2 < 0) {
					
					fwd = 0;
				
				} else {
				
					
					vehicle.position.x = vPosX;
					vehicle.position.z = vPosZ;			
				
					camera.position.x = vehicle.position.x + (dx*150);
					camera.position.z = vehicle.position.z + (dz*150);
				
					camera.target.x = camera.position.x;
					camera.target.y = vehicle.position.y;
					camera.target.z = camera.position.z;
				
					camera.lookAt(camera.target);
				
				}
				
				
				renderer.render( scene, camera );

			}

		</script>
		
		<!-- JavaScript at the bottom for fast page loading -->
		
		<!-- Asynchronous Google Analytics snippet. Change UA-XXXXX-X to be your site's ID.
		mathiasbynens.be/notes/async-analytics-snippet -->
		<script>
			var _gaq = [['_setAccount', 'UA-XXXXX-X'], ['_trackPageview']]; ( function(d, t) {
					var g = d.createElement(t), s = d.getElementsByTagName(t)[0];
					g.src = ('https:' == location.protocol ? '//ssl' : '//www') + '.google-analytics.com/ga.js';
					s.parentNode.insertBefore(g, s)
				}(document, 'script'));
		</script>

	</body>
</html>