<!doctype html> 

<!-- paulirish.com/2008/conditional-stylesheets-vs-css-hacks-answer-neither/ -->
<!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if IE 7]>    <html class="no-js lt-ie9 lt-ie8" lang="en"> <![endif]-->
<!--[if IE 8]>    <html class="no-js lt-ie9" lang="en"> <![endif]-->
<!-- Consider adding a manifest.appcache: h5bp.com/d/Offline -->

<!--[if gt IE 8]><!-->
<html class="no-js" lang="en">
<!--<![endif]-->
	
	<head>

		<meta charset="utf-8">

		<!-- Use the .htaccess and remove these lines to avoid edge case issues.
		More info: h5bp.com/i/378 -->
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

		<title></title>
		<meta name="description" content="">

		<!-- Mobile viewport optimized: h5bp.com/viewport -->
		<meta name="viewport" content="width=device-width">

		<!-- Place favicon.ico and apple-touch-icon.png in the root directory: mathiasbynens.be/notes/touch-icons -->
		
		<!-- Template style sheet -->
		<link rel="stylesheet" href="css/html5boilerplate.css">
		
		<!-- App styles -->
		<link rel="stylesheet" href="css/style.css">

		<!-- All JavaScript at the bottom, except this Modernizr build.
		Modernizr enables HTML5 elements & feature detects for optimal performance.
		Create your own custom Modernizr build: www.modernizr.com/download/ -->
		<script src="js/libs/modernizr-2.5.3.min.js"></script>
		
	</head>
	<body>
		
		<!-- Prompt IE 6 users to install Chrome Frame. Remove this if you support IE 6.
		chromium.org/developers/how-tos/chrome-frame-getting-started -->
		<!--[if lt IE 7]><p class=chromeframe>Your browser is <em>ancient!</em> <a href="http://browsehappy.com/">Upgrade to a different browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">install Google Chrome Frame</a> to experience this site.</p><![endif]-->
		
		Boingo!
		
		<script src="js/libs/three.min.js"></script>

		<script src="js/libs/stats.min.js"></script>

		<script>

			var container, stats;

			var camera, scene, renderer;
			var camZDelta = 0;
			var camXDelta = 0;
			var camDir = 0;
			var camAngle = 0;

			var vehicle, plane, floor;

			var targetRotation = 0;
			var targetRotationOnMouseDown = 0;

			var mouseX = 0;
			var mouseXOnMouseDown = 0;

			var windowHalfX = window.innerWidth / 2;
			var windowHalfY = window.innerHeight / 2;

			var fwd = 1;
			
			init();
			animate();

			function init() {

				container = document.createElement( 'div' );
				document.body.appendChild( container );

				var info = document.createElement( 'div' );
				info.style.position = 'absolute';
				info.style.top = '10px';
				info.style.width = '100%';
				info.style.textAlign = 'center';
				info.innerHTML = 'Hello...';
				container.appendChild( info );

				camera = new THREE.PerspectiveCamera( 25, window.innerWidth / window.innerHeight, 1, 10000 );
				camera.target = new THREE.Vector3( 0, 0, 0 );
				camera.position.set( 0, 75, 0 );

				scene = new THREE.Scene();
				
				// Floor
				
				//var planeSimple = new THREE.PlaneGeometry( 200, 300 );
				//var planeTesselated = new THREE.PlaneGeometry( 100, 300, 25, 40 );
				var planeTesselated = new THREE.PlaneGeometry( 2000, 2000, 20, 20 );
				var matWire = new THREE.MeshBasicMaterial( { color :0x110000, wireframe: true, wireframeLinewidth: 0.1 } );

				floor = new THREE.Mesh( planeTesselated, matWire );
				floor.rotation.x = - Math.PI / 2;
				floor.position.set( 0, 0, 0 );
				scene.add( floor );

				// Vehicle

				var geometry = new THREE.CubeGeometry( 20, 5, 30 );
				
				geometry.faces[0].color.setHex( 0x888888 );
				geometry.faces[1].color.setHex( 0xacacac );
				geometry.faces[2].color.setHex( 0xe0e0e0 );
				geometry.faces[3].color.setHex( 0xd3d3d3 );
				geometry.faces[4].color.setHex( 0x777777 );
				geometry.faces[5].color.setHex( 0xa0a0a0 );
				
				var material = new THREE.MeshBasicMaterial( { vertexColors: THREE.FaceColors } );

				vehicle = new THREE.Mesh( geometry, material );
				//vehicle.rotation.x = - Math.PI / 2;
				vehicle.position.set( 0, 30, 0 );
				scene.add( vehicle );

				// Shadow
				
				/*
				var geometry = new THREE.PlaneGeometry( 200, 200 );
				geometry.applyMatrix( new THREE.Matrix4().makeRotationX( - Math.PI / 2 ) );

				var material = new THREE.MeshBasicMaterial( { color: 0xe0e0e0 } );

				plane = new THREE.Mesh( geometry, material );
				scene.add( plane );
				*/

				renderer = new THREE.WebGLRenderer();
				renderer.setSize( window.innerWidth, window.innerHeight );

				container.appendChild( renderer.domElement );

				stats = new Stats();
				stats.domElement.style.position = 'absolute';
				stats.domElement.style.top = '0px';
				container.appendChild( stats.domElement );

				document.addEventListener( 'mousedown', onDocumentMouseDown, false );
				document.addEventListener( 'touchstart', onDocumentTouchStart, false );
				document.addEventListener( 'touchmove', onDocumentTouchMove, false );
				
				document.addEventListener( 'keyup', onKeyUp, false );
				document.addEventListener( 'keydown', onKeyDown, false );

				//

				window.addEventListener( 'resize', onWindowResize, false );
				
				alert(camera.position.z + "/" + floor.position.z);

			}

			function onWindowResize() {

				windowHalfX = window.innerWidth / 2;
				windowHalfY = window.innerHeight / 2;

				camera.aspect = window.innerWidth / window.innerHeight;
				camera.updateProjectionMatrix();

				renderer.setSize( window.innerWidth, window.innerHeight );

			}

			function onKeyUp(event) {
				
				event.preventDefault();
				
				if(event.keyCode == 38) {
					
					fwd = 0;
				
				} else if(event.keyCode == 37) {
					
					camDir = 0;
					
					/*
					var dx = Math.cos(camera.rotation.y);
					var dz = Math.sin(camera.rotation.y);
					
					camera.target.x = camera.position.x - (dx * 200);
					camera.target.z = camera.position.z - (dz * 200);
					
					camera.lookAt(camera.target);
					*/
					
					//alert(dx+"/"+dz);
					
				} else if(event.keyCode == 39) {
					
					camDir = 0;
					
					//alert(dx+"/"+dz);
					
				}
			
			}
			
			
			function onKeyDown(event) {
				
				event.preventDefault();
			
				if(event.keyCode == 38) {
					
					fwd = 4;
				
				} else if(event.keyCode == 37) {
					
					camDir = 0.01;
	
					//vehicle.position.x += dx*4;
					//camera.position.x += dx*4;
				
					//vehicle.position.z += dz*4;
					//camera.position.z += dz*4;
						
				} else if(event.keyCode == 39) {
					
					camDir = -0.01;
	
					//vehicle.position.x += dx*4;
					//camera.position.x += dx*4;
				
					//vehicle.position.z += dz*4;
					//camera.position.z += dz*4;
				
				
				}
				
			}
			
			
			//

			function onDocumentMouseDown( event ) {

				event.preventDefault();

				document.addEventListener( 'mousemove', onDocumentMouseMove, false );
				document.addEventListener( 'mouseup', onDocumentMouseUp, false );
				document.addEventListener( 'mouseout', onDocumentMouseOut, false );

				mouseXOnMouseDown = event.clientX - windowHalfX;
				targetRotationOnMouseDown = targetRotation;

			}

			function onDocumentMouseMove( event ) {

				mouseX = event.clientX - windowHalfX;

				targetRotation = targetRotationOnMouseDown + ( mouseX - mouseXOnMouseDown ) * 0.02;

			}

			function onDocumentMouseUp( event ) {

				document.removeEventListener( 'mousemove', onDocumentMouseMove, false );
				document.removeEventListener( 'mouseup', onDocumentMouseUp, false );
				document.removeEventListener( 'mouseout', onDocumentMouseOut, false );

			}

			function onDocumentMouseOut( event ) {

				document.removeEventListener( 'mousemove', onDocumentMouseMove, false );
				document.removeEventListener( 'mouseup', onDocumentMouseUp, false );
				document.removeEventListener( 'mouseout', onDocumentMouseOut, false );

			}

			function onDocumentTouchStart( event ) {

				if ( event.touches.length === 1 ) {

					event.preventDefault();

					mouseXOnMouseDown = event.touches[ 0 ].pageX - windowHalfX;
					targetRotationOnMouseDown = targetRotation;

				}

			}

			function onDocumentTouchMove( event ) {

				if ( event.touches.length === 1 ) {

					event.preventDefault();

					mouseX = event.touches[ 0 ].pageX - windowHalfX;
					targetRotation = targetRotationOnMouseDown + ( mouseX - mouseXOnMouseDown ) * 0.05;

				}

			}

			//

			function animate() {

				requestAnimationFrame( animate );

				render();
				stats.update();

			}

			function render() {
				
				//plane.rotation.y = vehicle.rotation.y;
				
				camAngle += camDir;
				
				var dz = -Math.cos(camAngle);
				var dx = -Math.sin(camAngle);
				
				camera.position.z += dz*fwd;
				//vehicle.position.z += dz*fwd;
				camera.position.x += dx*fwd;
				//vehicle.position.x += dx*fwd;
				
				//camera.rotation.y += camDir;
					
				camera.target.x = camera.position.x + (dx * 500);
				camera.target.z = camera.position.z + (dz * 500);
				
				vehicle.position.x = camera.position.x + (dx * 200); //camera.target.x;
				vehicle.position.z = camera.position.z + (dz * 200);
					
				camera.lookAt(camera.target);
				
				vehicle.rotation.y = camera.rotation.y;
				
				camZDelta += dz*fwd;
				camXDelta += dx*fwd;
				
				if(camZDelta < -100) {
					
					floor.position.z += -101;
					camZDelta = 0;
				
				} else if(camZDelta > 100) {
					
					floor.position.z -= -101;
					camZDelta = 0;
				
				}
				
				if(camXDelta < -100) {
					
					floor.position.x += -101;
					camXDelta = 0;
				
				} else if(camXDelta > 100) {
					
					floor.position.x -= -101;
					camXDelta = 0;
				}
				
				
				renderer.render( scene, camera );

			}

		</script>
		
		<!-- JavaScript at the bottom for fast page loading -->
		
		<!-- Asynchronous Google Analytics snippet. Change UA-XXXXX-X to be your site's ID.
		mathiasbynens.be/notes/async-analytics-snippet -->
		<script>
			var _gaq = [['_setAccount', 'UA-XXXXX-X'], ['_trackPageview']]; ( function(d, t) {
					var g = d.createElement(t), s = d.getElementsByTagName(t)[0];
					g.src = ('https:' == location.protocol ? '//ssl' : '//www') + '.google-analytics.com/ga.js';
					s.parentNode.insertBefore(g, s)
				}(document, 'script'));
		</script>

	</body>
</html>